<ui:composition template="/templates/pagina.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:components="http://xmlns.jcp.org/jsf/composite/components">

	<ui:define name="title">
        Cadastro de Cliente
    </ui:define>

	<ui:define name="content">
		<link rel="stylesheet"
			href="https://unpkg.com/leaflet/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

		<h:form id="form1">
			<p:growl id="mensagem" />

			<p:panel header="Cadastro de Cliente" id="painelCliente"
				styleClass="painel-custom-header">
				<p:panelGrid columns="2" layout="grid">
					<p:panelGrid columns="1" layout="grid">
						<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
							<h:panelGroup>
								<p:outputLabel value="Código" for="codigo" />
								<br />
								<p:inputText id="codigo" style="width: 100px"
									value="#{clienteBean.crudObj.cliIdCliente}" disabled="true" />
							</h:panelGroup>
						</p:panelGrid>

						<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
							<h:panelGroup>
								<p:outputLabel value="Nome Completo" for="nome" />
								<p:inputText id="nome" value="#{clienteBean.crudObj.cliNome}"
									required="true" maxlength="50" style="width:100%" />
							</h:panelGroup>

							<h:panelGroup>
								<p:outputLabel value="E-mail" for="email" />
								<p:inputText id="email" value="#{clienteBean.crudObj.cliEmail}"
									required="true" maxlength="64" style="width:100%" />
							</h:panelGroup>
						</p:panelGrid>

						<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
							<h:panelGroup>
								<p:outputLabel value="CPF" for="cpf" />
								<p:inputMask id="cpf" value="#{clienteBean.crudObj.cliCpf}"
									mask="999.999.999-99" required="true" style="width:100%">
								</p:inputMask>
							</h:panelGroup>

							<h:panelGroup>
								<p:outputLabel value="Telefone" for="telefone" />
								<p:inputMask id="telefone"
									value="#{clienteBean.crudObj.cliTelefone}"
									mask="(99) 99999-9999" required="true" style="width:100%" />
							</h:panelGroup>
						</p:panelGrid>

						<p:divider style="width: 99%;" />

						<h:panelGroup id="endereco">
							<p:dataTable id="enderecosTable" var="endereco"
								value="#{clienteBean.crudObj.cliEnderecos}" reflow="true"
								emptyMessage="Nenhum endereço adicionado">

								<p:column headerText="Descrição">
									<h:outputText value="#{endereco.endDescricao}" />
								</p:column>

								<p:column headerText="Rua">
									<h:outputText value="#{endereco.endRua}" />
								</p:column>

								<p:column headerText="Número">
									<h:outputText value="#{endereco.endNumero}" />
								</p:column>

								<p:column headerText="Cidade">
									<h:outputText value="#{endereco.endCidade}" />
								</p:column>

								<p:column headerText="UF" width="50">
									<h:outputText value="#{endereco.endUf}" />
								</p:column>

								<p:column headerText="Ações" width="150">
									<p:commandButton icon="pi pi-pencil"
										actionListener="#{clienteBean.editarEndereco(endereco)}"
										oncomplete="PF('dlgEndereco').show()"
										update=":form1:dialogEndereco" process="@this"
										styleClass="ui-button-success" />

									<p:commandButton icon="pi pi-trash"
										styleClass="ui-button-danger"
										actionListener="#{clienteBean.crudObj.removerEndereco(endereco)}"
										update="enderecosTable" process="@this"
										style="margin-left:10px;">
										<p:confirm header="Atenção!" message="Excluir este endereço?"
											icon="pi pi-exclamation-triangle" />
									</p:commandButton>

									<p:commandButton icon="pi pi-map-marker"
										onclick="mostrarMapa('#{endereco.endLatitude}', '#{endereco.endLongitude}', '#{endereco.endRua}'); return false;"
										type="button" style="margin-left:10px;" />
								</p:column>
							</p:dataTable>

							<p:commandButton value="Cadastrar Endereço" icon="pi pi-plus"
								oncomplete="PF('dlgEndereco').show()" process="@this"
								actionListener="#{clienteBean.novoEndereco()}"
								update=":form1:dialogEndereco" style="margin-top:10px;" />
						</h:panelGroup>
					</p:panelGrid>
				</p:panelGrid>
			</p:panel>

			<p:panel styleClass="painel-custom">
				<div align="right">
					<p:commandButton value="Salvar"
						actionListener="#{clienteBean.salvar()}" icon="pi pi-save"
						process="@form"
						update=":form1:painelCliente :form1:clientesTable :form1:mensagem"
						styleClass="btn-acoes ui-button-success" />

					<p:commandButton value="Novo"
						actionListener="#{clienteBean.criaObj()}" icon="pi pi-plus"
						process="@this"
						update=":form1:painelCliente :form1:painelCliente :form1:mensagem"
						styleClass="btn-acoes ui-button-secondary" />

					<p:commandButton value="Excluir"
						actionListener="#{clienteBean.deletar()}" icon="pi pi-trash"
						process="@this"
						update=":form1:painelCliente :form1:clientesTable :form1:mensagem"
						styleClass="btn-acoes ui-button-danger" />
				</div>
			</p:panel>

			<p:panel styleClass="painel-custom-header"
				header="Clientes Cadastrados">
				<p:dataTable id="clientesTable" var="cliente" reflow="true"
					sortBy="#{cliente.cliIdCliente}" sortOrder="ascending"
					value="#{clienteBean.clientes}" paginator="true" rows="10"
					paginatorPosition="bottom" style="margin-top:10px;"
					emptyMessage="Nenhum cliente encontrado" filterEvent="keyup">

					<p:column headerText="Código" width="85"
						sortBy="#{cliente.cliIdCliente}"
						filterBy="#{cliente.cliIdCliente}">
						<h:outputText value="#{cliente.cliIdCliente}" />
					</p:column>

					<p:column headerText="Nome" sortBy="#{cliente.cliNome}"
						filterBy="#{cliente.cliNome}">
						<h:outputText value="#{cliente.cliNome}" />
					</p:column>

					<p:column headerText="CPF" width="125" filterBy="#{cliente.cliCpf}">
						<h:outputText value="#{cliente.cpfFormatado}" />
					</p:column>

					<p:column headerText="Telefone" width="125">
						<h:outputText value="#{cliente.cliTelefone}" />
					</p:column>

					<p:column headerText="E-mail">
						<h:outputText value="#{cliente.cliEmail}" />
					</p:column>

					<p:column headerText="Ações" width="140">
						<p:commandButton icon="pi pi-user-edit"
							actionListener="#{clienteBean.selecionarCliente(cliente)}"
							process="@this"
							update=":form1:painelCliente :form1:clientesTable :form1:mensagem"
							styleClass="ui-button-success" style="margin-right: 5px;" />

						<p:commandButton icon="pi pi-trash" styleClass="ui-button-danger"
							actionListener="#{clienteBean.excluirCliente(cliente)}"
							update=":form1:clientesTable :form1:mensagem :form1:painelCliente"
							process="@this">
							<p:confirm header="Atenção!"
								message="Você tem certeza que deseja excluir esse registro?"
								icon="pi pi-exclamation-triangle" />
						</p:commandButton>
					</p:column>
				</p:dataTable>

				<p:confirmDialog global="true" showEffect="fade" hideEffect="fade"
					width="350">
					<p:commandButton value="Sim" type="button"
						styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
					<p:commandButton value="Não" type="button"
						styleClass="ui-confirmdialog-no" icon="pi pi-times" />
				</p:confirmDialog>
			</p:panel>

			<p:dialog id="dlgMapa" widgetVar="mapDialog"
				header="Localização do Cliente" modal="true" width="1200"
				height="600" responsive="true">
				<div id="mapaCliente" style="width: 100%; height: 600px;"></div>
			</p:dialog>

			<p:dialog id="dialogEndereco" widgetVar="dlgEndereco" modal="true"
				header="Cadastro de Endereço" width="700" closable="true"
				resizable="false">

				<p:panelGrid id="enderecoNovo" columns="1" layout="grid">
					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="Descrição" for="desc" />
							<p:inputText id="desc"
								value="#{clienteBean.novoEndereco.endDescricao}"
								style="width:100%">
								<p:ajax process="@this" />
							</p:inputText>
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="CEP" for="cepEnd" />
							<p:inputMask id="cepEnd" mask="99999-999"
								value="#{clienteBean.novoEndereco.endCep}" style="width:100%">
								<p:ajax event="blur"
									listener="#{clienteBean.preencherEnderecoPorCep()}"
									update="form1:enderecoNovo" />
							</p:inputMask>
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="Rua" for="ruaEnd" />
							<p:inputText id="ruaEnd"
								value="#{clienteBean.novoEndereco.endRua}" style="width:100%" />
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="Número" for="numEnd" />
							<p:inputText id="numEnd"
								value="#{clienteBean.novoEndereco.endNumero}" style="width:100%" />
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="Complemento" for="compEnd" />
							<p:inputText id="compEnd"
								value="#{clienteBean.novoEndereco.endComplemento}"
								style="width:100%" />
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="Bairro" for="bairroEnd" />
							<p:inputText id="bairroEnd"
								value="#{clienteBean.novoEndereco.endBairro}" style="width:100%" />
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="Cidade" for="cidadeEnd" />
							<p:inputText id="cidadeEnd"
								value="#{clienteBean.novoEndereco.endCidade}" style="width:100%" />
						</h:panelGroup>
					</p:panelGrid>

					<p:panelGrid columns="2" layout="grid" style="margin-left: -10px">
						<h:panelGroup>
							<p:outputLabel value="UF" for="ufEnd" />
							<p:inputText id="ufEnd" value="#{clienteBean.novoEndereco.endUf}"
								size="2" style="width:100%" />
						</h:panelGroup>
					</p:panelGrid>
				</p:panelGrid>
				<br />

				<div align="right">
					<p:commandButton value="Salvar" icon="pi pi-check"
						actionListener="#{clienteBean.salvarEndereco()}"
						update=":form1:enderecosTable" process="@form"
						oncomplete="PF('dlgEndereco').hide()"
						styleClass="ui-button-success btn-acoes" />
					<p:commandButton value="Cancelar" icon="pi pi-times"
						onclick="PF('dlgEndereco').hide()" type="button"
						styleClass="ui-button-secondary btn-acoes" />
				</div>
			</p:dialog>

		</h:form>

		<script>
		    var mapa = null;
		
		    function mostrarMapa(latStr, lngStr, nome) {
		        PF('mapDialog').show();
		
		        setTimeout(function() {
		            var latNum = parseFloat(String(latStr).replace(',', '.'));
		            var lngNum = parseFloat(String(lngStr).replace(',', '.'));
		
		            console.log('mostrarMapa() raw:', latStr, lngStr);
		            console.log('mostrarMapa() parsed:', latNum, lngNum);
		
		            if (isNaN(latNum) || isNaN(lngNum)) {
		                alert('Coordenadas inválidas para o cliente.\nLatitude: ' + latStr + '\nLongitude: ' + lngStr);
		                return;
		            }
		            if (mapa !== null) {
		                mapa.remove();
		                mapa = null;
		            }
		            mapa = L.map('mapaCliente', { scrollWheelZoom: false }).setView([latNum, lngNum], 15);
		
		            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		                maxZoom: 19,
		                attribution: '© OpenStreetMap contributors'
		            }).addTo(mapa);
		
		            L.marker([latNum, lngNum]).addTo(mapa)
		                .bindPopup(nome || 'Localização')
		                .openPopup();
		        }, 200);
		    }
		</script>
	</ui:define>
</ui:composition>
