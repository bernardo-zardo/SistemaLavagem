<ui:composition template="/templates/pagina.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core">

	<ui:define name="title">
        Agenda
    </ui:define>

	<ui:define name="content">

		<link rel="stylesheet"
			href="https://unpkg.com/leaflet/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

		<style>
.fc .fc-scrollgrid, .fc .fc-scrollgrid table, .fc-daygrid-body {
	width: 100% !important;
}

.fc-event.evento-pendente {
	background-color: #1a96cc !important;
	border-color: #1a96cc !important;
	color: #fff !important;
}

.fc-event.evento-concluido {
	background-color: #2e7d32 !important;
	border-color: #2e7d32 !important;
	color: #fff !important;
}

.fc-event.evento-outro {
	background-color: #9CA3AF !important;
	border-color: #9CA3AF !important;
	color: #fff !important;
}
</style>

		<h:form id="form1">
			<p:growl id="mensagem" />
			<p:panel header="Agenda" styleClass="painel-custom-header">
				<br />
				<p:panelGrid columns="1" layout="grid">
					<f:view encoding="UTF-8">
						<p:schedule id="agenda" rightHeaderTemplate="dayGridMonth"
							value="#{consultaAgendamentoBean.eventModel}" draggable="false"
							selectable="false" widgetVar="agendaWidget" locale="pt_BR"
							height="auto" timeZone="America/Sao_Paulo"
							clientTimeZone="America/Sao_Paulo">

							<p:ajax event="eventSelect"
								listener="#{consultaAgendamentoBean.onEventSelect}"
								update=":form1:dlgDetalhes"
								oncomplete="console.log('oncomplete args=', args); PF('dlgDetalhes').show(); carregarMapas(args.latBusca, args.lngBusca, args.latEntrega, args.lngEntrega);" />
						</p:schedule>
					</f:view>

					<br />
					<p:panelGrid layout="grid" columns="1">
						<p:outputLabel value="Legenda"
							style="font-weight: bold; margin-left: -5px" />

						<h:panelGroup layout="block"
							style="display:flex; align-items:center;">
							<div
								style="width: 20px; height: 20px; background-color: #1a96cc; border-radius: 4px; margin-right: 8px;"></div>
							<h:outputText value="Agendamento Pendente"
								style="font-size:14px;" />
						</h:panelGroup>

						<h:panelGroup layout="block"
							style="display:flex; align-items:center;">
							<div
								style="width: 20px; height: 20px; background-color: #2e7d32; border-radius: 4px; margin-right: 8px;"></div>
							<h:outputText value="Agendamento Concluído"
								style="font-size:14px;" />
						</h:panelGroup>
					</p:panelGrid>
				</p:panelGrid>
				<br />
			</p:panel>

			<p:dialog id="dlgDetalhes" widgetVar="dlgDetalhes"
				header="Detalhes do Agendamento" modal="true" resizable="false"
				width="50%">
				<p:panelGrid columns="1" layout="grid" style="width:100%;">

					<h:outputText
						value="#{consultaAgendamentoBean.agendamentoSelecionado.dataFormatada}"
						style="font-weight:bold; font-size:20px;" />

					<p:panelGrid columns="2" layout="grid"
						columnClasses="ui-g-nopad, ui-g-nopad"
						style="width:100%; background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1);
                   padding:15px 20px; margin-bottom:20px;">

						<h:outputText value="Horário:"
							style="font-weight:bold; color:#555;" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.horaFormatada}" />

						<h:outputText value="Cliente:" style="font-weight:bold;" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agVeiculo.veiCliente.cliNome}" />

						<h:outputText value="Veículo:" style="font-weight:bold;" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agVeiculo.veiModelo} - #{consultaAgendamentoBean.agendamentoSelecionado.agVeiculo.veiPlaca}" />

						<h:outputText value="Serviço:" style="font-weight:bold;"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null}" />
						<h:outputText
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null}"
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agTipoServico.tsNome}" />

						<h:outputText value="Serviço:" style="font-weight:bold;"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao ne null}" />
						<h:outputText
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao ne null}"
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao}" />

						<h:outputText value="Status:" style="font-weight:bold" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.statusDescricao}" />

						<h:outputText value="Endereço de Busca:"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo}"
							style="font-weight:bold;" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agEnderecoBusca.itemLabel}"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo}" />

						<h:outputText value="Endereço de Entrega:"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo}"
							style="font-weight:bold;" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agEnderecoEntrega.itemLabel}"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo}" />

						<h:outputText value="Taxa Adicional:"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null and (consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo or consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo)}"
							style="font-weight:bold" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agPrecoServicoExtra}"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null and (consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo or consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo)}">
							<f:convertNumber type="currency" currencySymbol="R$ "
								locale="pt_BR" />
						</h:outputText>

						<h:outputText value="Preço Total:" style="font-weight:bold;"
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null}" />
						<h:outputText
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null}"
							value="#{consultaAgendamentoBean.agendamentoSelecionado.precoTotalDesc}" />
					</p:panelGrid>

					<p:panelGrid
						columns="#{(consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo and consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo) ? 2 : 1}"
						layout="grid" style="width:100%; gap:20px;">

						<h:panelGroup
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo}">

							<h:outputText value="Local de Busca" style="font-weight:bold;" />

							<div id="mapaBusca"
								style="width: 100%; height: 300px; border-radius: 10px; overflow: hidden;"></div>
						</h:panelGroup>

						<h:panelGroup
							rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo}">

							<h:outputText value="Local de Entrega" style="font-weight:bold;" />

							<div id="mapaEntrega"
								style="width: 100%; height: 300px; border-radius: 10px; overflow: hidden;"></div>
						</h:panelGroup>
					</p:panelGrid>

				</p:panelGrid>

				<script>
				    //<![CDATA[
				    function safeParse(v) {
				        if (v === null || v === undefined) return null;
				        if (typeof v === 'number') return v;
				        if (v === 'null') return null;
				        var n = parseFloat(String(v).replace(',', '.'));
				        return isNaN(n) ? null : n;
				    }
				
				    function elementExists(id) {
				        return document.getElementById(id) !== null;
				    }
				
				    function carregarMapas(latBusca, lngBusca, latEntrega, lngEntrega) {
				        console.log('carregarMapas called with:', latBusca, lngBusca, latEntrega, lngEntrega);
				
				        latBusca = safeParse(latBusca);
				        lngBusca = safeParse(lngBusca);
				        latEntrega = safeParse(latEntrega);
				        lngEntrega = safeParse(lngEntrega);
				
				        if (!latBusca && !latEntrega) {
				            console.warn('Nenhuma coordenada disponível (busca ou entrega).');
				            return;
				        }
				
				        if (elementExists('mapaBusca') && latBusca && lngBusca) {
				            if (window._mapaBuscaInstance) {
				                try { window._mapaBuscaInstance.remove(); } catch(e){console.warn(e); }
				                window._mapaBuscaInstance = null;
				            }
				
				            window._mapaBuscaInstance = L.map('mapaBusca', { scrollWheelZoom: false }).setView([latBusca, lngBusca], 14);
				            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap contributors' }).addTo(window._mapaBuscaInstance);
				            L.marker([latBusca, lngBusca]).addTo(window._mapaBuscaInstance).bindPopup('Local de Busca').openPopup();
				        }
				
				        if (elementExists('mapaEntrega') && latEntrega && lngEntrega) {
				            if (window._mapaEntregaInstance) {
				                try { window._mapaEntregaInstance.remove(); } catch(e){console.warn(e); }
				                window._mapaEntregaInstance = null;
				            }
				
				            window._mapaEntregaInstance = L.map('mapaEntrega', { scrollWheelZoom: false }).setView([latEntrega, lngEntrega], 14);
				            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap contributors' }).addTo(window._mapaEntregaInstance);
				            L.marker([latEntrega, lngEntrega]).addTo(window._mapaEntregaInstance).bindPopup('Local de Entrega').openPopup();
				        }
				    }
				    //]]>
				</script>
			</p:dialog>
		</h:form>
	</ui:define>
</ui:composition>
