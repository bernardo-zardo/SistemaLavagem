<ui:composition template="/templates/pagina.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core">

	<ui:define name="title">
        Controle de Agendamento
    </ui:define>

	<ui:define name="content">

		<h:form id="form1">
			<p:growl id="mensagem" />
			<p:panel header="Filtros de Agendamento" id="panelFiltrosAgendamento"
				styleClass="painel-custom-header">

				<p:panelGrid columns="2" layout="grid">
					<p:panelGrid columns="1" layout="grid">

						<p:panelGrid columns="2" layout="grid"
							columnClasses="ui-g-nopad, ui-g-nopad" style="margin-left:-10px">
							<h:panelGroup>
								<p:outputLabel value="Data Inicial" for="dataIniAg" />
								<br />
								<p:datePicker id="dataIniAg" showOnFocus="false"
									widgetVar="dataIniAgWidget"
									value="#{consultaAgendamentoBean.filtroDataIni}"
									showIcon="true" pattern="dd/MM/yyyy" styleClass="datePicker"
									style="width:200px" />
							</h:panelGroup>

							<h:panelGroup>
								<p:outputLabel value="Data Final" for="dataFimAg" />
								<br />
								<p:datePicker id="dataFimAg" showOnFocus="false"
									widgetVar="dataFimAgWidget"
									value="#{consultaAgendamentoBean.filtroDataFim}"
									showIcon="true" pattern="dd/MM/yyyy" styleClass="datePicker"
									style="width:200px" />
							</h:panelGroup>
						</p:panelGrid>

						<p:panelGrid columns="2" layout="grid" style="margin-left:-10px">
							<p:selectCheckboxMenu id="tiposServicoAg"
								value="#{consultaAgendamentoBean.filtroTiposServico}"
								label="Tipos de Serviço" filter="true"
								filterMatchMode="contains" style="width: 100%"
								converter="tipoServicoConsultaConverter">
								<f:selectItems value="#{consultaAgendamentoBean.tiposServico}"
									var="t" itemLabel="#{t.tsNome}" itemValue="#{t}" />
							</p:selectCheckboxMenu>
						</p:panelGrid>

						<p:panelGrid columns="2" layout="grid" style="margin-left:-10px">
							<p:selectCheckboxMenu id="veiculosAg"
								value="#{consultaAgendamentoBean.filtroVeiculos}"
								label="Veículos" filter="true" filterMatchMode="contains"
								style="width: 100%" converter="veiculoConsultaConverter">
								<f:selectItems value="#{consultaAgendamentoBean.veiculos}"
									var="v" itemLabel="#{v.veiModelo} - #{v.veiPlaca}"
									itemValue="#{v}" />
							</p:selectCheckboxMenu>
						</p:panelGrid>

						<p:panelGrid columns="1" layout="grid" style="margin-left:-10px">
							<p:outputLabel value="Status" />
							<p:selectOneRadio id="statusAg"
								value="#{consultaAgendamentoBean.filtroStatus}"
								layout="lineDirection">
								<f:selectItem itemLabel="Todos" itemValue="T" />
								<f:selectItem itemLabel="Pendentes" itemValue="P" />
								<f:selectItem itemLabel="Concluídos" itemValue="C" />
								<f:selectItem itemLabel="Cancelados" itemValue="X" />
							</p:selectOneRadio>
						</p:panelGrid>
					</p:panelGrid>
				</p:panelGrid>
			</p:panel>

			<p:panel styleClass="painel-custom">
				<div align="right">
					<p:commandButton value="Limpar Filtros" icon="pi pi-eraser"
						actionListener="#{consultaAgendamentoBean.limparFiltros}"
						update=":form1:panelAgendamentos" styleClass="btn-acoes-auto" />

					<p:commandButton value="Pesquisar" icon="pi pi-search"
						actionListener="#{consultaAgendamentoBean.filtrarAgendamentos}"
						styleClass="btn-acoes ui-button-success"
						update=":form1:panelAgendamentos" />
				</div>
			</p:panel>

			<p:panel id="panelAgendamentos" styleClass="painel-custom-header"
				header="Agendamentos Filtrados">

				<p:dataGrid id="gridAgendamentos" layout="grid"
					value="#{consultaAgendamentoBean.agendamentosFiltrados}" var="a"
					columns="3" paginator="true" rows="9" paginatorPosition="bottom"
					styleClass="dataGrid-servicos"
					emptyMessage="Nenhum agendamento encontrado.">

					<p:panel styleClass="card-total-fixo" style="min-height: 250px">
						<p:panelGrid columns="1" layout="grid" style="margin-left:-10px;">

							<p:panelGrid layout="grid" columns="2"
								columnClasses="ui-grid-col-11,ui-grid-col-1">
								<p:panelGrid layout="grid" columns="2"
									columnClasses="ui-grid-col-1,ui-grid-col-11"
									style="align-items: center; margin-left: -20px">
									<h:panelGroup>
										<i class="#{a.statusIcon}"
											style="#{a.statusIconStyle}; font-size: 20px; vertical-align: middle; margin-left: -5px"></i>
									</h:panelGroup>

									<h:outputText
										value="#{a.dataPadraoFormatada} - #{a.horaFormatada}"
										style="font-weight: bold; font-size: 19px; margin-left: -8px" />
								</p:panelGrid>


								<p:panelGrid layout="grid" columns="1">
									<p:button icon="pi pi-pencil"
										outcome="/restrito/cadastros/agendamento.xhtml"
										styleClass="ui-button-success" style="margin-right: 5px;"
										target="_blank">
										<f:param name="agendamentoId" value="#{a.agIdAgendamento}" />
									</p:button>
								</p:panelGrid>
							</p:panelGrid>

							<p:panelGrid layout="grid" columns="1"
								style="margin-left: -10px; margin-top: -10px">
								<h:panelGroup rendered="#{a.agTipoServico ne null}">
									<h:outputText value="#{a.agTipoServico.tsNome}"
										style="font-weight: bold;" />
								</h:panelGroup>

								<h:panelGroup rendered="#{a.agTipoServico eq null}">
									<h:outputText value="#{a.agObservacao}"
										style="font-weight: bold;" />
								</h:panelGroup>

								<h:outputText value="Status: #{a.statusDescricao}"
									style="#{a.statusStyle}" />

								<h:outputText value="Cliente: #{a.agVeiculo.veiCliente.cliNome}" />

								<h:outputText
									value="Veículo: #{a.agVeiculo.veiModelo} - #{a.agVeiculo.veiPlaca}" />

								<h:outputText value="#{a.descEntrega}" />

								<h:panelGroup rendered="#{a.agTipoServico ne null}">
									<h:outputText value="Preço total: #{a.precoTotalDesc}"
										style="font-weight: bold;" />
								</h:panelGroup>
							</p:panelGrid>
						</p:panelGrid>

						<h:panelGroup rendered="#{a.statusPendente}">
							<div align="right">
								<p:commandButton value="Cancelar" icon="pi pi-times"
									actionListener="#{consultaAgendamentoBean.cancelarAgendamento(a)}"
									update=":form1:mensagem :form1:panelAgendamentos"
									styleClass="link-cancelar" process="@this">
									<p:confirm header="Atenção!"
										message="Cancelar este agendamento?"
										icon="pi pi-exclamation-triangle" />
								</p:commandButton>

								<p:commandButton value="Concluir Serviço" icon="pi pi-check"
									styleClass="link-concluir"
									actionListener="#{consultaAgendamentoBean.prepararConclusao(a)}"
									oncomplete="PF('dlgConcluirServico').show()"
									update=":form1:dialogConcluirServico">
								</p:commandButton>
							</div>
						</h:panelGroup>
					</p:panel>
				</p:dataGrid>
			</p:panel>

			<p:confirmDialog global="true" showEffect="fade" hideEffect="fade"
				width="350">
				<p:commandButton value="Sim" type="button"
					styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
				<p:commandButton value="Não" type="button"
					styleClass="ui-confirmdialog-no" icon="pi pi-times" />
			</p:confirmDialog>

			<p:dialog id="dialogConcluirServico" header="Concluir Agendamento"
				widgetVar="dlgConcluirServico" modal="true" closable="true"
				resizable="false" width="500"
				style="border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.2);">

				<p:panelGrid columns="2" layout="grid"
					columnClasses="ui-g-nopad, ui-g-nopad"
					style="width:100%; background:#fff; border-radius:12px; 
			   box-shadow:0 2px 6px rgba(0,0,0,0.1);
			   padding:15px 20px; margin-bottom:20px;">

					<h:outputText value="Serviço:"
						style="font-weight:bold; color:#555;"
						rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao ne null}" />
					<h:outputText
						value="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao}"
						rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao ne null}" />

					<h:outputText value="Serviço:"
						rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null}"
						style="font-weight:bold; color:#555;" />
					<h:outputText
						rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao eq null}"
						value="#{consultaAgendamentoBean.agendamentoSelecionado.agTipoServico.tsNome}" />

					<h:outputText value="Cliente:"
						style="font-weight:bold; color:#555;" />
					<h:outputText
						value="#{consultaAgendamentoBean.agendamentoSelecionado.agVeiculo.veiCliente.cliNome}" />

					<h:outputText value="Veículo:"
						style="font-weight:bold; color:#555;" />
					<h:outputText
						value="#{consultaAgendamentoBean.agendamentoSelecionado.agVeiculo.veiModelo} - #{consultaAgendamentoBean.agendamentoSelecionado.agVeiculo.veiPlaca}" />

					<h:outputText value="Data:" style="font-weight:bold; color:#555;" />
					<h:outputText
						value="#{consultaAgendamentoBean.agendamentoSelecionado.dataPadraoFormatada}" />

					<h:outputText value="Horário:"
						style="font-weight:bold; color:#555;" />
					<h:outputText
						value="#{consultaAgendamentoBean.agendamentoSelecionado.horaFormatada}" />

					<h:panelGroup
						rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agPrecoServicoExtra ne null}">
						<h:outputText value="Preço Total:"
							style="font-weight:bold; color:#555;" />
						<h:outputText
							value="#{consultaAgendamentoBean.agendamentoSelecionado.precoTotalDesc}" />
					</h:panelGroup>

					<h:panelGroup
						rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao ne null}">
						<p:outputLabel value="Preço do Serviço de Busca/Entrega"
							for="preco" style="font-weight:bold; color:#555;" />
						<p:inputNumber id="preco"
							disabled="#{not consultaAgendamentoBean.agendamentoSelecionado.agPossuiBuscaVeiculo and not consultaAgendamentoBean.agendamentoSelecionado.agPossuiEntregaVeiculo}"
							value="#{consultaAgendamentoBean.agendamentoSelecionado.agPrecoServicoExtra}"
							required="true" requiredMessage="O campo Preço é obrigatório."
							symbol="R$ " decimalPlaces="2" thousandSeparator="."
							decimalSeparator="," style="width:100%" />
					</h:panelGroup>
				</p:panelGrid>

				<p:panelGrid columns="1" layout="grid">
					<h:outputLabel for="responsavel" value="Responsável pelo serviço:"
						style="font-weight:bold;" />
					<p:selectOneMenu id="responsavel"
						value="#{consultaAgendamentoBean.responsavelSelecionado}"
						style="width:100%; border-radius:6px; border:1px solid #ccc;">
						<f:selectItem itemLabel="Selecione..." itemValue="#{null}"
							noSelectionOption="true" />
						<f:selectItems value="#{consultaAgendamentoBean.responsaveis}"
							var="r" itemLabel="#{r.resNome}" itemValue="#{r}" />
					</p:selectOneMenu>
				</p:panelGrid>

				<p:panelGrid columns="1" layout="grid" rendered="#{consultaAgendamentoBean.agendamentoSelecionado.agObservacao ne null}">
					<p:outputLabel value="Tipo de Serviço" for="tipoServico" style="font-weight:bold;" />
					<p:selectOneMenu id="tipoServico"
						value="#{consultaAgendamentoBean.tipoServicoSelecionado}"
						style="width:100%">
						<f:selectItem itemLabel="Selecione um tipo" itemValue="#{null}"
							noSelectionOption="true" />
						<f:selectItems value="#{consultaAgendamentoBean.tiposServico}"
							var="t" itemLabel="#{t.tsNome}" itemValue="#{t}" />
					</p:selectOneMenu>
				</p:panelGrid>

				<f:facet name="footer">
					<p:commandButton value="Salvar" icon="pi pi-check"
						actionListener="#{consultaAgendamentoBean.concluirServico()}"
						update=":form1:mensagem :form1:panelAgendamentos"
						oncomplete="PF('dlgConcluirServico').hide()"
						styleClass="ui-button-success" />
					<p:commandButton value="Fechar" icon="pi pi-times"
						onclick="PF('dlgConcluirServico').hide();return false;"
						styleClass="ui-button-secondary" />
				</f:facet>
			</p:dialog>
		</h:form>
	</ui:define>
</ui:composition>
